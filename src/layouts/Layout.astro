---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

interface Props {
	title: string;
	description?: string;
	image?: string;
	canonicalURL?: string;
	type?: string;
}

const { 
	title, 
	description = "Reto Playas Costa Rica - Documentando +600 playas de Costa Rica. Explora mapas interactivos, descubre playas poco conocidas y conoce la verdadera riqueza de nuestro país.",
	image = "/images/hero.JPG",
	canonicalURL,
	type = "website"
} = Astro.props;

const siteURL = Astro.site?.href || "https://retoplayascr.com";
const currentURL = canonicalURL || new URL(Astro.url.pathname, siteURL).href;
const ogImage = new URL(image, siteURL).href;
---

<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content={description} />
		<meta name="generator" content={Astro.generator} />
		<link rel="canonical" href={currentURL} />
		<link rel="icon" type="image/png" href="/images/logo.png" />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={currentURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={ogImage} />
		<meta property="og:locale" content="es_CR" />
		<meta property="og:site_name" content="Reto Playas Costa Rica" />
		
		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={currentURL} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImage} />
		<meta name="twitter:creator" content="@retoplayascr" />
		
		<!-- Schema.org JSON-LD -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "TravelAgency",
			"name": "Reto Playas Costa Rica",
			"description": description,
			"url": siteURL,
			"logo": new URL("/images/logo.png", siteURL).href,
			"image": ogImage,
			"sameAs": [
				"https://instagram.com/retoplayascr",
				"https://tiktok.com/@retoplayascr",
				"https://www.youtube.com/@RetoPlayasCR"
			],
			"founder": {
				"@type": "Person",
				"name": "Cristóbal Quesada"
			},
			"areaServed": {
				"@type": "Country",
				"name": "Costa Rica"
			}
		})} />
		
		<!-- Google Fonts with font-display swap and preload -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat&family=DM+Sans:opsz,wght@9..40,100..1000&family=Oswald:wght@200..700&family=Permanent+Marker&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap">
		<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat&family=DM+Sans:opsz,wght@9..40,100..1000&family=Oswald:wght@200..700&family=Permanent+Marker&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
		<noscript><link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Caveat&family=DM+Sans:opsz,wght@9..40,100..1000&family=Oswald:wght@200..700&family=Permanent+Marker&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet"></noscript>
		
		<!-- Preload critical resources -->
		<link rel="preload" as="image" href="/images/hero.JPG" fetchpriority="high">
		<link rel="preload" as="image" href="/images/logo.png" fetchpriority="high">
		
		<!-- Prefetch important pages -->
		<link rel="prefetch" href="/mapas">
		<link rel="prefetch" href="/blog">
		
		<!-- Leaflet CSS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

		<title>{title}</title>
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
	</head>
	<body class="bg-sand-light text-text-primary min-h-screen flex flex-col">
		<Header />
		<main class="flex-grow">
			<slot />
		</main>
		<Footer />
		
		<script is:inline>
			if (window.netlifyIdentity) {
				window.netlifyIdentity.on("init", user => {
					if (!user) {
						window.netlifyIdentity.on("login", () => {
							document.location.href = "/admin/";
						});
					}
				});
			}

			// Immediate check for token redirection
			(function() {
				const hash = window.location.hash;
				if (hash.includes('invite_token=') || 
					hash.includes('confirmation_token=') || 
					hash.includes('recovery_token=') ||
					hash.includes('email_change_token=') ||
					hash.includes('_token=')) {
					
					// If we are not already in /admin/, redirect immediately
					if (!window.location.pathname.startsWith('/admin')) {
						window.location.href = "/admin/" + hash;
					}
				}
			})();
		</script>
	</body>
</html>

